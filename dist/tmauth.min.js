!function(t){t.module("tmauth.config",[]).value("tmauth.config",{debug:!0}),t.module("tmauth.directives",["tmauth.controllers"]),t.module("tmauth.constants",[]),t.module("tmauth.filters",[]),t.module("tmauth.services",["tmauth.constants"]),t.module("tmauth.controllers",["tmauth.services"]),t.module("tmauth",["ui.bootstrap","tmauth.config","tmauth.directives","tmauth.constants","tmauth.filters","tmauth.services"])}(angular),angular.module("tmauth.constants").constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"}),angular.module("tmauth.constants").constant("USER_ROLES",{all:"*",admin:"admin",user:"user",guest:"guest"}),angular.module("tmauth.controllers").controller("LoginCtrl",["$scope","$rootScope","authService",function(t,e,o){var n=this;this.form={username:void 0,password:void 0},this.isAlreadyLoggedIn=function(){return o.isAuthenticated()},this.login=function(){o.login(n.form.username,n.form.password)}}]),angular.module("tmauth.controllers").controller("LoginDialogCtrl",["authService","$rootScope","$scope",function(t,e,o){this.form={username:void 0,password:void 0},this.login=function(e,n){t.login(e,n).then(function(t){o.$close(t)})}}]),angular.module("tmauth.directives").directive("tmInlineLoginForm",function(){var t='<form class="tm-inline-login-form navbar-form navbar-right"ng-submit="auth.login()"ng-hide="auth.isAlreadyLoggedIn()"><div class="form-group"><input type="text" placeholder="username" class="form-control"ng-model="auth.form.username"></div><div class="form-group"><input type="password" placeholder="password" class="form-control"ng-model="auth.form.password"></div><button type="submit" class="btn btn-success">Sign in</button></form>';return{template:t,restrict:"E",controller:"LoginCtrl",controllerAs:"auth"}}),angular.module("tmauth.services").factory("User",["USER_ROLES",function(t){function e(t,e,o){this.id=t,this.name=e,this.roles=o}return e.prototype.isAdmin=function(){return _(this.roles).contains(t.admin)},e}]),angular.module("tmauth.services").factory("authInterceptor",["$q","$window",function(t,e){function o(t){t.headers=t.headers||{};var o=e.sessionStorage.token;return angular.isDefined(o)&&(t.headers.Authorization="JWT "+o),t}function n(e){return 401===e.status&&console.log("User not authenticated!"),e||t.when(e)}return{request:o,response:n}}]),angular.module("tmauth.services").service("authService",["$http","session","User","$rootScope","AUTH_EVENTS",function(t,e,o,n,r){this.login=function(o,s){var i={username:o,password:s};return t.post("/auth",i).success(function(t){var o=t.access_token,s=e.create(o);return n.$broadcast(r.loginSuccess),s}).error(function(){e.destroy(),n.$broadcast(r.loginFailed)})},this.logout=function(){e.destroy(),n.$broadcast(r.logoutSuccess)},this.isAuthenticated=function(){var t=e.isAuth();return t},this.isAuthorized=function(t){angular.isArray(t)||(t=[t]);var o=_(e.user.roles).map(function(e){return _(t).contains(e)});return this.isAuthenticated()&&_.some(o)}}]),angular.module("tmauth.services").factory("jwtUtil",["$window",function(t){function e(e){function o(e){return e=e.replace("-","+").replace("_","/"),JSON.parse(t.atob(e))}var n=e.split("."),r=n[0],s=n[1];return{header:o(r),payload:o(s)}}function o(t){var o=e(t),n=o.payload.exp,r=new Date(0);return r.setUTCSeconds(n),!(r.valueOf()>(new Date).valueOf())}return{decodeToken:e,isTokenExpired:o}}]),angular.module("tmauth.services").service("loginDialogService",["$modal","$rootScope",function(t){this.showDialog=function(){var e=t.open({templateUrl:"/templates/main/auth/login-dialog.html",controller:"LoginDialogCtrl",controllerAs:"login"});return e.result}}]),angular.module("tmauth.services").service("session",["$window","jwtUtil","User","$interval",function(t,e,o,n){function r(o){function r(){var o=t.sessionStorage.token,n=!_.isUndefined(o);if(n){var r=e.isTokenExpired(o),s=!!u;r&&console.log("Token expired"),(r||!s)&&(l=!1)}else l=!1}n(r,o)}function s(){n.cancel(c)}function i(){l=!0,r(1e3)}function a(){s(),l=!1}var u=null,l=!1,c=void 0,d=t.sessionStorage.token;if(angular.isDefined(d)&&!e.isTokenExpired(d)){console.log("Restoring session from existing token...");var h=e.decodeToken(d),m=h.payload;u=new o(m.uid,m.uname,m.uroles),i()}this.create=function(n){{var r=e.decodeToken(n),s=r.payload;r.header}return u=new o(s.uid,s.uname,s.uroles),t.sessionStorage.token=n,i(),u},this.destroy=function(){delete t.sessionStorage.token,u=null,a()},this.getUser=function(){return u},this.isAuth=function(){return l}}]);